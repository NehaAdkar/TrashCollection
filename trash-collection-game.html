<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>EcoClean - Gamified Trash Collection</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        :root {
            --primary: #4CAF50;
            --secondary: #8BC34A;
            --dark: #2E7D32;
            --light: #C8E6C9;
            --accent: #FFC107;
            --danger: #F44336;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Poppins', sans-serif;
        }
        
        body {
            background-color: #f5f5f5;
            color: #333;
        }
        
        .app-container {
            display: flex;
            height: 100vh;
        }
        
        /* Sidebar Styles */
        .sidebar {
            width: 350px;
            background-color: white;
            box-shadow: 2px 0 10px rgba(0,0,0,0.1);
            padding: 20px;
            display: flex;
            flex-direction: column;
            z-index: 10;
        }
        
        .user-profile {
            display: flex;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }
        
        .avatar {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--light);
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 15px;
            font-size: 24px;
            color: var(--dark);
            overflow: hidden;
        }
        
        .avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        
        .user-info h3 {
            font-size: 18px;
            margin-bottom: 5px;
        }
        
        .user-info p {
            font-size: 14px;
            color: #666;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .level-display {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }
        
        .progress-bar {
            height: 10px;
            background-color: #eee;
            border-radius: 5px;
            overflow: hidden;
        }
        
        .progress-fill {
            height: 100%;
            width: 65%;
            background-color: var(--primary);
            border-radius: 5px;
            transition: width 0.3s;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .stat-card {
            background-color: var(--light);
            padding: 15px;
            border-radius: 8px;
            text-align: center;
        }
        
        .stat-card h4 {
            font-size: 24px;
            color: var(--dark);
            margin-bottom: 5px;
        }
        
        .stat-card p {
            font-size: 12px;
            color: #666;
        }
        
        .action-buttons {
            margin-top: auto;
        }
        
        .btn {
            display: block;
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            margin-bottom: 10px;
            transition: all 0.3s;
            text-align: center;
        }
        
        .btn-primary {
            background-color: var(--primary);
            color: white;
        }
        
        .btn-primary:hover {
            background-color: var(--dark);
        }
        
        .btn-secondary {
            background-color: var(--accent);
            color: #333;
        }
        
        .btn-secondary:hover {
            background-color: #FFB300;
        }
        
        .btn-danger {
            background-color: var(--danger);
            color: white;
        }
        
        .btn-danger:hover {
            background-color: #D32F2F;
        }
        
        /* Map Container Styles */
        .map-container {
            flex-grow: 1;
            position: relative;
        }
        
        #map {
            height: 100%;
            width: 100%;
        }
        
        /* Report Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            width: 90%;
            max-width: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
        }
        
        .modal-header {
            background-color: var(--primary);
            color: white;
            padding: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .modal-header h3 {
            font-size: 18px;
        }
        
        .close-modal {
            background: none;
            border: none;
            color: white;
            font-size: 24px;
            cursor: pointer;
        }
        
        .modal-body {
            padding: 20px;
        }
        
        .form-group {
            margin-bottom: 15px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .camera-preview {
            width: 100%;
            height: 200px;
            background-color: #eee;
            margin-bottom: 15px;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }
        
        #photoPreview, #collectionPhotoPreview {
            max-width: 100%;
            max-height: 100%;
            display: none;
        }
        
        .camera-icon {
            font-size: 40px;
            color: #999;
        }
        
        .capture-btn {
            background-color: var(--primary);
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 5px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 5px;
        }
        
        .modal-footer {
            padding: 15px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            border-top: 1px solid #eee;
        }
        
        /* Collection Dialog Styles */
        .collection-dialog {
            position: absolute;
            z-index: 1000;
            background: white;
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
            max-width: 300px;
            transform: translate(-50%, -100%);
        }
        
        /* Login Modal Styles */
        .login-modal .modal-content {
            max-width: 400px;
        }
        
        .login-options {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }
        
        /* Responsive Styles */
        @media (max-width: 768px) {
            .app-container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            #map {
                height: 60vh;
            }
        }
    </style>
</head>
<body>
    <div class="app-container">
        <!-- Sidebar -->
        <div class="sidebar">
            <div class="user-profile">
                <div class="avatar" id="userAvatar">
                    <i class="fas fa-user" id="avatarIcon"></i>
                    <img id="avatarImage" style="display: none;">
                </div>
                <div class="user-info">
                    <h3 id="username">EcoWarrior</h3>
                    <p id="userLevel">Loading...</p>
                </div>
            </div>
            
            <div class="progress-container">
                <div class="level-display">
                    <span id="levelText">Level 1</span>
                    <span id="xpText">0/100 XP</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
            </div>
            
            <div class="stats">
                <div class="stat-card">
                    <h4 id="collectionsCount">0</h4>
                    <p>Total Collections</p>
                </div>
                <div class="stat-card">
                    <h4 id="pointsCount">0</h4>
                    <p>Points Earned</p>
                </div>
                <div class="stat-card">
                    <h4 id="badgesCount">0</h4>
                    <p>Badges</p>
                </div>
                <div class="stat-card">
                    <h4 id="rankText">#-</h4>
                    <p>Leaderboard Rank</p>
                </div>
            </div>
            
            <div class="action-buttons">
                <button class="btn btn-primary" id="reportTrashBtn">
                    <i class="fas fa-plus-circle"></i> Report Trash
                </button>
                <button class="btn btn-secondary" id="leaderboardBtn">
                    <i class="fas fa-trophy"></i> View Leaderboard
                </button>
                <button class="btn btn-danger" id="logoutBtn">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
        </div>
        
        <!-- Map Container -->
        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>
    
    <!-- Report Trash Modal -->
    <div class="modal" id="reportModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Report Trash Location</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div class="form-group">
                    <label>Location</label>
                    <input type="text" id="trashLocation" readonly>
                </div>
                
                <div class="form-group">
                    <label>Trash Type</label>
                    <select id="trashType">
                        <option value="general">General Waste</option>
                        <option value="plastic">Plastic</option>
                        <option value="paper">Paper</option>
                        <option value="metal">Metal</option>
                        <option value="glass">Glass</option>
                        <option value="hazardous">Hazardous Waste</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Description (Optional)</label>
                    <textarea id="trashDescription" rows="3" placeholder="Describe the trash or any special instructions"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Verification Photo</label>
                    <div class="camera-preview" id="cameraPreview">
                        <i class="fas fa-camera camera-icon" id="cameraIcon"></i>
                        <img id="photoPreview" alt="Preview">
                    </div>
                    <input type="file" id="photoInput" accept="image/*" capture="environment" style="display: none;">
                    <button class="capture-btn" id="captureBtn">
                        <i class="fas fa-camera"></i> Take Photo
                    </button>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="cancelReport">Cancel</button>
                <button class="btn btn-primary" id="submitReport">Submit Report</button>
            </div>
        </div>
    </div>
    
    <!-- Login Modal -->
    <div class="modal login-modal" id="loginModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Welcome to EcoClean</h3>
            </div>
            <div class="modal-body">
                <div class="login-options">
                    <button id="googleLogin" class="btn btn-secondary">
                        <i class="fab fa-google"></i> Sign in with Google
                    </button>
                    <button id="anonymousLogin" class="btn btn-primary">
                        <i class="fas fa-user-secret"></i> Continue Anonymously
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Leaderboard Modal -->
    <div class="modal" id="leaderboardModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Top EcoCleaners</h3>
                <button class="close-modal">&times;</button>
            </div>
            <div class="modal-body">
                <div id="leaderboardList" style="max-height: 400px; overflow-y: auto;">
                    <p>Loading leaderboard...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button class="btn btn-secondary" id="closeLeaderboard">Close</button>
            </div>
        </div>
    </div>

    <!-- Firebase and Maps API -->
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.0/firebase-storage-compat.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?key=YOUR_GOOGLE_MAPS_API_KEY&libraries=places"></script>
    
    <script>
        // Firebase configuration - REPLACE WITH YOUR ACTUAL CONFIG
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
        apiKey: "AIzaSyA3xh9dsOtsY304X0nD7OOxjf_Gkc3qZ_Y",
        authDomain: "trash-collection-31adb.firebaseapp.com",
        projectId: "trash-collection-31adb",
        storageBucket: "trash-collection-31adb.firebasestorage.app",
        messagingSenderId: "582419009812",
        appId: "1:582419009812:web:30a05c2446cd352d6d7201",
        measurementId: "G-9SHYSY9HZN"
        };

        // Initialize Firebase
        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();
        const storage = firebase.storage();
        
        // Global variables
        let currentUser = null;
        let map = null;
        let userLocation = null;
        let trashMarkers = {};
        let userListener = null;
        let leaderboardListener = null;

        // DOM Elements
        const elements = {
            // User profile elements
            userAvatar: document.getElementById('userAvatar'),
            avatarIcon: document.getElementById('avatarIcon'),
            avatarImage: document.getElementById('avatarImage'),
            username: document.getElementById('username'),
            userLevel: document.getElementById('userLevel'),
            levelText: document.getElementById('levelText'),
            xpText: document.getElementById('xpText'),
            progressFill: document.getElementById('progressFill'),
            collectionsCount: document.getElementById('collectionsCount'),
            pointsCount: document.getElementById('pointsCount'),
            badgesCount: document.getElementById('badgesCount'),
            rankText: document.getElementById('rankText'),
            
            // Buttons
            reportTrashBtn: document.getElementById('reportTrashBtn'),
            leaderboardBtn: document.getElementById('leaderboardBtn'),
            logoutBtn: document.getElementById('logoutBtn'),
            
            // Modals
            loginModal: document.getElementById('loginModal'),
            reportModal: document.getElementById('reportModal'),
            leaderboardModal: document.getElementById('leaderboardModal'),
            
            // Report modal elements
            trashLocation: document.getElementById('trashLocation'),
            trashType: document.getElementById('trashType'),
            trashDescription: document.getElementById('trashDescription'),
            cameraPreview: document.getElementById('cameraPreview'),
            cameraIcon: document.getElementById('cameraIcon'),
            photoPreview: document.getElementById('photoPreview'),
            photoInput: document.getElementById('photoInput'),
            captureBtn: document.getElementById('captureBtn'),
            cancelReport: document.getElementById('cancelReport'),
            submitReport: document.getElementById('submitReport'),
            
            // Login modal elements
            googleLogin: document.getElementById('googleLogin'),
            anonymousLogin: document.getElementById('anonymousLogin'),
            
            // Leaderboard elements
            leaderboardList: document.getElementById('leaderboardList'),
            closeLeaderboard: document.getElementById('closeLeaderboard')
        };

        // Initialize the application
        function initApp() {
            setupAuth();
            setupEventListeners();
            
            // Check auth state
            auth.onAuthStateChanged(user => {
                if (user) {
                    // User is signed in
                    currentUser = user;
                    loadUserData(user.uid);
                    initializeMapForUser(user);
                    elements.loginModal.style.display = 'none';
                } else {
                    // No user is signed in
                    currentUser = null;
                    elements.loginModal.style.display = 'flex';
                    if (map) {
                        map.unbindAll();
                        map = null;
                    }
                }
            });
        }

        // Setup authentication system
        function setupAuth() {
            // Google Sign-In
            elements.googleLogin.addEventListener('click', () => {
                const provider = new firebase.auth.GoogleAuthProvider();
                auth.signInWithPopup(provider)
                    .then(result => {
                        if (result.additionalUserInfo.isNewUser) {
                            // Create user profile in Firestore
                            return db.collection('users').doc(result.user.uid).set({
                                displayName: result.user.displayName,
                                email: result.user.email,
                                photoURL: result.user.photoURL,
                                points: 0,
                                level: 1,
                                reportsCount: 0,
                                collectionsCount: 0,
                                badges: ['welcome'],
                                createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                                lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                            });
                        }
                    })
                    .catch(error => {
                        console.error('Login error:', error);
                        alert('Login failed: ' + error.message);
                    });
            });

            // Anonymous Login
            elements.anonymousLogin.addEventListener('click', () => {
                auth.signInAnonymously()
                    .catch(error => {
                        console.error('Anonymous login error:', error);
                        alert('Login failed: ' + error.message);
                    });
            });

            // Logout
            elements.logoutBtn.addEventListener('click', () => {
                auth.signOut();
            });
        }

        // Setup event listeners
        function setupEventListeners() {
            // Report trash button
            elements.reportTrashBtn.addEventListener('click', () => {
                if (!currentUser) {
                    alert('Please sign in to report trash');
                    return;
                }
                elements.reportModal.style.display = 'flex';
            });

            // Leaderboard button
            elements.leaderboardBtn.addEventListener('click', () => {
                showLeaderboard();
            });

            // Close leaderboard
            elements.closeLeaderboard.addEventListener('click', () => {
                elements.leaderboardModal.style.display = 'none';
                if (leaderboardListener) {
                    leaderboardListener();
                }
            });

            // Report modal events
            elements.captureBtn.addEventListener('click', () => {
                elements.photoInput.click();
            });

            elements.photoInput.addEventListener('change', (e) => {
                const file = e.target.files[0];
                if (file) {
                    const reader = new FileReader();
                    reader.onload = (event) => {
                        elements.photoPreview.src = event.target.result;
                        elements.photoPreview.style.display = 'block';
                        elements.cameraIcon.style.display = 'none';
                    };
                    reader.readAsDataURL(file);
                }
            });

            elements.cancelReport.addEventListener('click', () => {
                resetReportModal();
                elements.reportModal.style.display = 'none';
            });

            elements.submitReport.addEventListener('click', async () => {
                await submitTrashReport();
            });

            // Close modals when clicking outside
            document.querySelectorAll('.modal').forEach(modal => {
                modal.addEventListener('click', (e) => {
                    if (e.target === modal) {
                        modal.style.display = 'none';
                        if (modal.id === 'reportModal') {
                            resetReportModal();
                        }
                    }
                });
            });
        }

        // Reset report modal
        function resetReportModal() {
            elements.photoPreview.src = '';
            elements.photoPreview.style.display = 'none';
            elements.cameraIcon.style.display = 'block';
            elements.trashDescription.value = '';
            elements.photoInput.value = '';
            elements.submitReport.disabled = false;
            elements.submitReport.innerHTML = 'Submit Report';
        }

        // Load user data from Firestore
        function loadUserData(userId) {
            if (userListener) userListener(); // Remove previous listener
            
            userListener = db.collection('users').doc(userId).onSnapshot(doc => {
                if (doc.exists) {
                    const userData = doc.data();
                    
                    // Update UI with user data
                    elements.username.textContent = userData.displayName || 'EcoWarrior';
                    elements.userLevel.textContent = `Level ${userData.level}`;
                    elements.levelText.textContent = `Level ${userData.level}`;
                    
                    // Calculate XP for progress bar
                    const xpNeeded = userData.level * 100;
                    const xpPercentage = (userData.points % xpNeeded) / xpNeeded * 100;
                    elements.xpText.textContent = `${userData.points % xpNeeded}/${xpNeeded} XP`;
                    elements.progressFill.style.width = `${xpPercentage}%`;
                    
                    // Update stats
                    elements.collectionsCount.textContent = userData.collectionsCount || 0;
                    elements.pointsCount.textContent = userData.points || 0;
                    elements.badgesCount.textContent = userData.badges ? userData.badges.length : 0;
                    
                    // Update avatar
                    if (currentUser.photoURL) {
                        elements.avatarImage.src = currentUser.photoURL;
                        elements.avatarImage.style.display = 'block';
                        elements.avatarIcon.style.display = 'none';
                    } else {
                        elements.avatarImage.style.display = 'none';
                        elements.avatarIcon.style.display = 'block';
                    }
                    
                    // Update rank (this would be more efficient with a dedicated leaderboard collection)
                    updateUserRank(userId, userData.points);
                }
            }, error => {
                console.error('Error loading user data:', error);
            });
        }

        // Update user's rank in the leaderboard
        function updateUserRank(userId, points) {
            db.collection('users')
                .orderBy('points', 'desc')
                .limit(100)
                .get()
                .then(snapshot => {
                    let rank = 1;
                    let found = false;
                    
                    snapshot.forEach(doc => {
                        if (doc.id === userId) {
                            elements.rankText.textContent = `#${rank}`;
                            found = true;
                        }
                        rank++;
                    });
                    
                    if (!found) {
                        elements.rankText.textContent = `#${rank}+`;
                    }
                })
                .catch(error => {
                    console.error('Error getting leaderboard:', error);
                });
        }

        // Show leaderboard
        function showLeaderboard() {
            elements.leaderboardModal.style.display = 'flex';
            elements.leaderboardList.innerHTML = '<p>Loading leaderboard...</p>';
            
            if (leaderboardListener) leaderboardListener(); // Remove previous listener
            
            leaderboardListener = db.collection('users')
                .orderBy('points', 'desc')
                .limit(50)
                .onSnapshot(snapshot => {
                    if (snapshot.empty) {
                        elements.leaderboardList.innerHTML = '<p>No users found</p>';
                        return;
                    }
                    
                    let html = '<ol style="list-style-type: none; padding: 0; margin: 0;">';
                    let rank = 1;
                    
                    snapshot.forEach(doc => {
                        const user = doc.data();
                        const isCurrentUser = doc.id === currentUser.uid;
                        
                        html += `
                            <li style="padding: 10px; border-bottom: 1px solid #eee; ${isCurrentUser ? 'background-color: var(--light);' : ''}">
                                <div style="display: flex; align-items: center; justify-content: space-between;">
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <span style="font-weight: bold; min-width: 20px;">${rank}.</span>
                                        <div style="width: 30px; height: 30px; border-radius: 50%; background-color: #eee; overflow: hidden;">
                                            ${user.photoURL ? 
                                                `<img src="${user.photoURL}" style="width: 100%; height: 100%; object-fit: cover;">` : 
                                                `<i class="fas fa-user" style="width: 100%; height: 100%; display: flex; align-items: center; justify-content: center;"></i>`}
                                        </div>
                                        <span>${user.displayName || 'Anonymous'}</span>
                                    </div>
                                    <span style="font-weight: bold; color: var(--dark);">${user.points || 0} pts</span>
                                </div>
                            </li>
                        `;
                        rank++;
                    });
                    
                    html += '</ol>';
                    elements.leaderboardList.innerHTML = html;
                }, error => {
                    console.error('Error loading leaderboard:', error);
                    elements.leaderboardList.innerHTML = '<p>Error loading leaderboard</p>';
                });
        }

        // Initialize map for authenticated user
        function initializeMapForUser(user) {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    position => {
                        userLocation = {
                            lat: position.coords.latitude,
                            lng: position.coords.longitude
                        };
                        
                        createMap(userLocation);
                        setupReportModal();
                        loadTrashReports();
                    },
                    error => {
                        console.error('Geolocation error:', error);
                        userLocation = { lat: 0, lng: 0 }; // Default location
                        createMap(userLocation);
                        setupReportModal();
                        loadTrashReports();
                    },
                    { enableHighAccuracy: true, timeout: 5000, maximumAge: 0 }
                );
            } else {
                userLocation = { lat: 0, lng: 0 }; // Default location
                createMap(userLocation);
                setupReportModal();
                loadTrashReports();
            }
        }

        // Create Google Map
        function createMap(center) {
            map = new google.maps.Map(document.getElementById('map'), {
                center: center,
                zoom: 15,
                mapTypeControl: false,
                streetViewControl: false,
                fullscreenControl: false,
                styles: [
                    {
                        featureType: 'poi',
                        stylers: [{ visibility: 'off' }]
                    }
                ]
            });
            
            // Add user marker
            if (userLocation.lat !== 0 && userLocation.lng !== 0) {
                new google.maps.Marker({
                    position: userLocation,
                    map: map,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/blue-dot.png'
                    },
                    title: 'Your Location'
                });
            }
            
            return map;
        }

        // Load trash reports from Firestore
        function loadTrashReports() {
            // Clear existing markers
            Object.values(trashMarkers).forEach(marker => marker.setMap(null));
            trashMarkers = {};
            
            db.collection('trashReports')
                .where('status', '==', 'uncleaned')
                .onSnapshot(snapshot => {
                    snapshot.docChanges().forEach(change => {
                        const report = change.doc;
                        const data = report.data();
                        
                        if (change.type === 'added' || change.type === 'modified') {
                            const location = {
                                lat: data.location.latitude,
                                lng: data.location.longitude
                            };
                            
                            addTrashMarker(report.id, location, data.type);
                        }
                        
                        if (change.type === 'removed') {
                            if (trashMarkers[report.id]) {
                                trashMarkers[report.id].setMap(null);
                                delete trashMarkers[report.id];
                            }
                        }
                    });
                }, error => {
                    console.error('Error loading trash reports:', error);
                });
        }

        // Add trash marker to map
        function addTrashMarker(id, location, type) {
            if (trashMarkers[id]) {
                trashMarkers[id].setMap(null);
            }
            
            const icon = {
                url: getTrashIcon(type),
                scaledSize: new google.maps.Size(32, 32)
            };
            
            const marker = new google.maps.Marker({
                position: location,
                map: map,
                icon: icon,
                title: `${type} trash`
            });
            
            // Add click event for collection
            marker.addListener('click', () => {
                showCollectionDialog(marker, id, type);
            });
            
            trashMarkers[id] = marker;
        }

        // Get appropriate trash icon
        function getTrashIcon(type) {
            const icons = {
                'general': 'https://cdn-icons-png.flaticon.com/512/3393/3393858.png',
                'plastic': 'https://cdn-icons-png.flaticon.com/512/3393/3393835.png',
                'paper': 'https://cdn-icons-png.flaticon.com/512/3393/3393842.png',
                'metal': 'https://cdn-icons-png.flaticon.com/512/3393/3393848.png',
                'glass': 'https://cdn-icons-png.flaticon.com/512/3393/3393839.png',
                'hazardous': 'https://cdn-icons-png.flaticon.com/512/3393/3393845.png'
            };
            return icons[type] || icons['general'];
        }

        // Setup report modal functionality
        function setupReportModal() {
            if (!userLocation || !map) return;
            
            elements.trashLocation.value = `${userLocation.lat.toFixed(6)}, ${userLocation.lng.toFixed(6)}`;
        }

        // Submit trash report to Firestore
        async function submitTrashReport() {
            const trashType = elements.trashType.value;
            const description = elements.trashDescription.value;
            const file = elements.photoInput.files[0];
            
            if (!file) {
                alert('Please take a verification photo to report trash.');
                return;
            }
            
            // Show loading state
            elements.submitReport.disabled = true;
            elements.submitReport.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Submitting...';
            
            try {
                // 1. Upload the photo to Firebase Storage
                const storageRef = storage.ref(`trash_photos/${currentUser.uid}/${Date.now()}_${file.name}`);
                const uploadTask = await storageRef.put(file);
                const photoUrl = await uploadTask.ref.getDownloadURL();
                
                // 2. Save the report to Firestore
                await db.collection('trashReports').add({
                    location: new firebase.firestore.GeoPoint(userLocation.lat, userLocation.lng),
                    type: trashType,
                    description: description,
                    photoUrl: photoUrl,
                    reporterId: currentUser.uid,
                    reporterName: currentUser.displayName || 'Anonymous',
                    status: 'uncleaned',
                    createdAt: firebase.firestore.FieldValue.serverTimestamp(),
                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // 3. Update user points
                await db.collection('users').doc(currentUser.uid).update({
                    points: firebase.firestore.FieldValue.increment(10),
                    reportsCount: firebase.firestore.FieldValue.increment(1),
                    lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                });
                
                // Show success message
                alert('Thank you for reporting! +10 EcoPoints awarded.');
                
                // Reset and close modal
                resetReportModal();
                elements.reportModal.style.display = 'none';
            } catch (error) {
                console.error('Error submitting report:', error);
                alert('There was an error submitting your report. Please try again.');
                elements.submitReport.disabled = false;
                elements.submitReport.innerHTML = 'Submit Report';
            }
        }

        // Show collection dialog when clicking on trash marker
        function showCollectionDialog(marker, reportId, trashType) {
            if (!currentUser) {
                alert('Please sign in to collect trash');
                return;
            }
            
            // Create dialog element
            const dialog = document.createElement('div');
            dialog.className = 'collection-dialog';
            dialog.style.top = `${marker.getPosition().lat()}px`;
            dialog.style.left = `${marker.getPosition().lng()}px`;
            
            dialog.innerHTML = `
                <h3 style="margin-bottom: 10px; font-size: 16px;">Collect ${trashType} Trash</h3>
                <p style="margin-bottom: 15px; font-size: 14px;">Take a photo to verify collection and earn 50 points!</p>
                <div id="collectionCameraPreview" style="width: 100%; height: 150px; background: #eee; margin-bottom: 10px; display: flex; justify-content: center; align-items: center;">
                    <i class="fas fa-camera" style="font-size: 30px; color: #999;"></i>
                </div>
                <input type="file" id="collectionPhotoInput" accept="image/*" capture="environment" style="display: none;">
                <div style="display: flex; justify-content: space-between;">
                    <button id="takeCollectionPhoto" style="background: var(--primary); color: white; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        <i class="fas fa-camera"></i> Take Photo
                    </button>
                    <button id="cancelCollection" style="background: #ddd; border: none; padding: 8px 15px; border-radius: 5px; cursor: pointer;">
                        Cancel
                    </button>
                </div>
            `;
            
            // Add to map container
            document.getElementById('map').appendChild(dialog);
            
            // Position the dialog above the marker
            const overlay = new google.maps.OverlayView();
            overlay.draw = function() {
                const div = dialog;
                const point = this.getProjection().fromLatLngToDivPixel(marker.getPosition());
                
                if (point) {
                    div.style.left = (point.x - div.offsetWidth / 2) + 'px';
                    div.style.top = (point.y - div.offsetHeight - 40) + 'px';
                }
            };
            overlay.setMap(map);
            
            // Set up event listeners
            dialog.querySelector('#takeCollectionPhoto').addEventListener('click', () => {
                dialog.querySelector('#collectionPhotoInput').click();
            });
            
            dialog.querySelector('#collectionPhotoInput').addEventListener('change', async (e) => {
                const file = e.target.files[0];
                if (!file) return;
                
                // Show loading state
                dialog.innerHTML = '<div style="padding: 20px; text-align: center;"><i class="fas fa-spinner fa-spin"></i> Verifying collection...</div>';
                
                try {
                    // 1. Upload verification photo
                    const storageRef = storage.ref(`collection_photos/${currentUser.uid}/${reportId}_${Date.now()}.jpg`);
                    const uploadTask = await storageRef.put(file);
                    const photoUrl = await uploadTask.ref.getDownloadURL();
                    
                    // 2. Update report status
                    await db.collection('trashReports').doc(reportId).update({
                        status: 'collected',
                        collectedBy: currentUser.uid,
                        collectedAt: firebase.firestore.FieldValue.serverTimestamp(),
                        verificationPhoto: photoUrl
                    });
                    
                    // 3. Update user points
                    await db.collection('users').doc(currentUser.uid).update({
                        points: firebase.firestore.FieldValue.increment(50),
                        collectionsCount: firebase.firestore.FieldValue.increment(1),
                        lastActivity: firebase.firestore.FieldValue.serverTimestamp()
                    });
                    
                    // 4. Remove marker
                    marker.setMap(null);
                    delete trashMarkers[reportId];
                    
                    // Show success
                    dialog.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--primary);"><i class="fas fa-check-circle"></i> Collection verified! +50 points</div>';
                    setTimeout(() => {
                        dialog.remove();
                        overlay.setMap(null);
                    }, 2000);
                } catch (error) {
                    console.error('Collection error:', error);
                    dialog.innerHTML = '<div style="padding: 20px; text-align: center; color: var(--danger);">Error verifying collection. Please try again.</div>';
                }
            });
            
            dialog.querySelector('#cancelCollection').addEventListener('click', () => {
                dialog.remove();
                overlay.setMap(null);
            });
        }

        // Initialize the app when window loads
        window.addEventListener('DOMContentLoaded', initApp);
    </script>
</body>
</html>